# マルチワールドGC

## もくじ

- <a name="C9"></a>[はじめに](#c1)
- <a name="C9"></a>[実装](#c5)
- <a name="C9"></a>[参考文献](#c9)

## <a name="c1"></a>[はじめに](#C1)

new_world gc はスタックのレベルで世界を分けていました。
世界はネストしていて、階層構造にはなっていましたが、複数の世界が独立して存在する事はありませんでした。
ここでは、複数の世界を持つ事を考えます。

複数のメモリ領域があるということは、親の世界が子を複数持つ事が出来るという事です。
そして、子供同士がデータのやり取りが出来るかもしれません。
ただ、子供同士の世界が共有出来れば良いのでしょうか？うーん。

そういう場合は、子供用のデータが欲しいなら、親が子供を作って子供が孫を複数作って子供がデータを管理して孫同士渡してまわり、
終わったら結果を親に返せば最小で済む気がする。
Webサーバであれば、リクエストがあったらメモリ領域を作って処理し、送信してしまえば領域を消せばよいので何も残らないはずである。


とにかく考えるべきは、IDを持ち、レベルではなくIDで管理する事でしょう。

計算世界のIDが同じであれば、同じ世界であり、IDが違う時は違う世界です。

## <a name="c5"></a>[実装](#c5)

[gc.c](gc.c)に実装があります。もうとりあえず作りながら考えましょう。
たぶん、新しい世界を作るときには、新しい世界を新たにぶち立てて、古い世界は一度別の所に移動させます。
そして、終わったら元に戻します。ただし、新しい世界はすぐに消さずに、元の世界に参照として残ります。
元の世界から参照されている間は、残り続けますが、参照がなくなるか、強制的に消されるとようやく消えます。
複数の世界が参照することはできますが、影響を与えられるのは自分の世界だけです。
計算が終わると、元の世界にバトンタッチして計算は終わるけれど、世界はすぐには終わらない。

ということであるのです。

## <a name="c9"></a>[参考文献](#C9)