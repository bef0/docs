# 多相型推論+型クラス=関数

型クラスの実装が難しい所は、letで型クラスの変数を別の変数にバインドする処理である。この処理に焦点を絞り制限付きの言語を作る。

	over add a = 'a -> 'a -> 'a in
	inst add int = fun a -> fun b -> a + b in
	add 1 2

または

	over add a = 'a -> 'a -> 'a in
	inst add int = fun a -> fun b -> a + b in
	let a = add in a 1 2

と書ける言語を考える。この言語は以下の特徴を持つ:

1. 多相的な型推論に、型に述語を付ける拡張を行う。
2. let recはない。
3. 型クラスは関数１つしか持てない。
4. 変数名はかぶらない。

ここで型スキームの型変数は'aとクォートを使って書く。

## 述語環境とクラス環境

この言語の処理系では型クラスの制約を表す述語環境と型クラスの辞書を持つ型クラス環境を持つ事にする。
述語環境には型変数と述語を保存する。
クラス環境には、関数名から型と辞書を保存する。
述語環境とクラス環境にはローカルな関数も含める。

### 例

	let (a:'t1->'t1->'t1) = (add:'t1->'t1->'t1) in (a:'t2->'t2->'t2)
	
以上の式で、クラス環境は

	Map(
		add -> Map(int->dict1, 't1->a_dict)
	)

述語環境は

	List(
		't1 -> add,
		't2 -> add
	)

となる。

### 変更タイミング

overでクラス環境に名前を追加する。
instでクラス環境のクラス名に型を追加する。
letでクラス環境に名前と型を追加する。
変数を具体化する時に述語環境に型変数とクラス名を追加する。

## 型推論と式変換とプレースホルダ挿入

型推論器は型と式を返す。
overとinstの式は書き換え、ELetとEVarはプレースホルダEPLet,EPVarに必要に応じて書き換える。

### クラス定義(EOver)

1. 型環境に関数の型スキームを追加する
2. 述語環境に型パラメータの述語を追加する
3. クラス環境に名前を追加する
4. ELet(クラス名,EAbs("dict",EVar("dict")), 式2)に置き換える

### インスタンス定義(EInst)

1. クラス環境から関数名で型から辞書へのマップを取り出す
2. 辞書変数名を作る
3. クラス環境に型名と辞書名を追加する
4. 型環境から型スキームを取り出し式e1の型チェックを行う
5. ELet(辞書名,e1,e2)に置き換える

### 具体化(EVar)

変数を参照したら具体化する。

1. 型スキーム中に型パラメータがあれば対応する型変数を新たに作る。
2. 型変数に述語を取得する。
3. 述語があれば、型と変数名を述語環境に保存する。
4. 述語があれば、型が決定されていない可能性があるのでプレースホルダEPVar(string,sc)に置き換える。

△ TODO: letrecのクラス環境に、型変数に対応する、述語の辞書がない場合が有り得て、トラバース後に求まるので述語は型のリンクにする。

### 一般化(ELet)

letがあれば、一般化する。
letの変数に束縛する式の型は決定出来るので、型パラメータや述語も決定出来る。

△TODO: ここで、述語の変数を作る必要がある。

1. 型から型パラメータを取り出し、型スキームを作る。
2. 型パラメータから述語を取り出す。
3. 述語がある場合、クラス環境に名前と述語に対する変数名を保存する。
4. 述語がある場合、式はプレースホルダEPLet(x,sc,e1,e2)に置き換える。

## プレーン処理

ここで、型を１つにまとめ確定していなかった述語が１つになる。

1. 述語環境を１つにまとめる。
2. 式をトラバースする。
3. 型変数をプレーンな物に置き換える。
4. プレースホルダを適切に書き換える。

### 変数のプレースホルダ置き換え(EPVar)

最初のトラバースでは型が決定出来てなかったが、型が決定出来ている。

1. EPVar(変数名,型スキーム)の型スキームと変数名を取り出す。
2. 型スキームをプレーンにする。
3. クラス環境から変数名の述語のクラスを取り出す。
4. クラスの型パラメータに対応する、辞書を求める。
5. EApp(辞書,EVar(変数名))に置き換える。

### letプレースホルダ置き換え(EPLet)

EPLetのプレースホルダは、ELetに置き換える。

1. EPLet(x,sc,e1,e2)の型スキームから、型パラメータを求める。
2. 型パラメータと述語環境から述語を求める。
3. 述語からクラスの辞書を求める。
4. ELet(x,EAbs(EVar(辞書), e1), e2)に置き換える。

△TODO: この一般化のプレースホルダは、Let Recでなければいらない可能性があるので検証する。これはLetRec実装後にする。
